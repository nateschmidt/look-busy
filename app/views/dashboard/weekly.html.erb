<div class="container py-4">
           <!-- Page Title -->
         <div class="mb-4">
           <div class="d-flex justify-content-between align-items-start">
             <div>
               <h1 class="h2 mb-0">
                 <i class="bi bi-list-check me-2"></i>Week <%= @selected_week %> To-Do List
               </h1>
               <p class="text-muted mb-0">
                 <%= @current_week_start.strftime("%B %d") %> - <%= @current_week_end.strftime("%B %d, %Y") %>
               </p>
             </div>
             <% if @todo_items.any? %>
               <%= link_to weekly_report_path(year: @selected_year, week: @selected_week), 
                   class: "btn btn-outline-primary",
                   target: "_blank" do %>
                 <i class="bi bi-file-earmark-text me-1"></i>Generate Report
               <% end %>
             <% end %>
             

           </div>
         </div>

  <!-- Week Selection and Quick Add Row -->
  <div class="row mb-4">
    <!-- Week Selector and Generate Section -->
    <div class="col-md-6">
      <div class="card shadow h-100">
        <div class="card-header bg-secondary text-white">
          <h3 class="h5 mb-0">
            Week Selection & Generation
          </h3>
        </div>
        <div class="card-body">
          <div class="d-flex flex-column align-items-center">
            <!-- Week Selector -->
            <div class="d-flex align-items-center mb-3">
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week - 1), 
                  class: "btn btn-sm btn-outline-secondary me-2",
                  disabled: @selected_week <= 1 do %>
                <i class="bi bi-chevron-left"></i>
              <% end %>
              
              <span class="fw-bold mx-2">
                Week <%= @selected_week %> of <%= @selected_year %>
              </span>
              
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week + 1), 
                  class: "btn btn-sm btn-outline-secondary ms-2",
                  disabled: @selected_week >= 52 do %>
                <i class="bi bi-chevron-right"></i>
              <% end %>
            </div>
            
            <!-- Buttons -->
            <div class="d-flex gap-2">
              <%= form_with url: generate_todos_path, method: :post, local: true do |form| %>
                <%= form.hidden_field :year, value: @selected_year %>
                <%= form.hidden_field :week, value: @selected_week %>
                <%= form.submit "Generate To-dos", 
                    class: "btn btn-primary",
                    data: { confirm: "Generate to-do items for Week #{@selected_week} of #{@selected_year}?" } %>
              <% end %>
              
              <% if @todos_generated %>
                <%= form_with url: clear_todos_path, method: :delete, local: true do |form| %>
                  <%= form.hidden_field :year, value: @selected_year %>
                  <%= form.hidden_field :week, value: @selected_week %>
                  <%= form.submit "Clear All To-dos", 
                      class: "btn btn-outline-danger",
                      data: { 
                        turbo_confirm: "This will permanently delete ALL to-do items for Week #{@selected_week} of #{@selected_year}. Are you sure?" 
                      } %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Add Form -->
    <div class="col-md-6">
      <div class="card shadow h-100">
        <div class="card-header bg-info text-white">
          <h3 class="h5 mb-0">
            Quick Add To-Do
          </h3>
        </div>
        <div class="card-body d-flex flex-column justify-content-center">
          <%= form_with model: AdHocTodo.new, local: true do |form| %>
            <div class="mb-3">
              <%= form.text_field :description, 
                  class: "form-control", 
                  placeholder: "Enter a new to-do item... (add ' m' for meeting)",
                  required: true %>
            </div>
            <div class="text-center">
              <%= form.submit "Add To-Do", class: "btn btn-info w-100" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <% if @todo_items.any? %>
    <div class="card shadow">
              <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="h5 mb-0">
              <% if params[:filter].present? && params[:filter] != 'all' %>
                <%= params[:filter].titleize %> To-Do Items (<%= @todo_items.count %> total)
              <% else %>
                Your To-Do Items (<%= @todo_items.incomplete.count %> incomplete, <%= @todo_items.completed.count %> completed)
              <% end %>
            </h3>
            
            <!-- Filter Buttons -->
            <div class="d-flex gap-1">
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week, filter: 'all'), 
                  class: "btn btn-sm #{params[:filter].blank? || params[:filter] == 'all' ? 'btn-light' : 'btn-outline-light'}" do %>
                <i class="bi bi-list-ul me-1"></i>All
              <% end %>
              
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week, filter: 'meetings'), 
                  class: "btn btn-sm #{params[:filter] == 'meetings' ? 'btn-light' : 'btn-outline-light'}" do %>
                Meetings
              <% end %>
              
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week, filter: 'goals'), 
                  class: "btn btn-sm #{params[:filter] == 'goals' ? 'btn-light' : 'btn-outline-light'}" do %>
                <i class="bi bi-target me-1"></i>Goals
              <% end %>
              
              <%= link_to weekly_dashboard_path(year: @selected_year, week: @selected_week, filter: 'ad_hoc'), 
                  class: "btn btn-sm #{params[:filter] == 'ad_hoc' ? 'btn-light' : 'btn-outline-light'}" do %>
                Ad Hoc
              <% end %>
            </div>
          </div>
        </div>
      <div class="card-body">
        <div class="row">
          <% @todo_items.each_with_index do |todo_item, index| %>
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card h-100 border-2 todo-card <%= 'completed' if todo_item.completed? %>" id="todo-card-<%= index %>" style="position: relative;">
                <div class="card-body p-3"
                     <% if todo_item.source_type == 'RecurringMeeting' || (todo_item.source_type == 'AdHocTodo' && todo_item.source.description.end_with?(' m')) %>
                       style="background-color: var(--meeting-bg);"
                     <% elsif todo_item.source_type == 'Goal' %>
                       style="background-color: var(--goal-bg);"
                     <% elsif todo_item.source_type == 'AdHocTodo' %>
                       style="background-color: var(--adhoc-bg);"
                     <% end %>>
                  <div class="d-flex align-items-start mb-2">
                    <div class="form-check me-2">
                      <input class="form-check-input todo-checkbox" 
                             type="checkbox" 
                             id="todo-<%= index %>" 
                             data-todo-id="<%= todo_item.id %>"
                             <%= 'checked' if todo_item.completed? %>
                             style="transform: scale(1.1);">
                      <label class="form-check-label" for="todo-<%= index %>"></label>
                    </div>
                    
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <% if todo_item.source_type == 'Goal' %>
                          <i class="bi bi-target text-success me-1"></i>
                        <% end %>
                      </div>
                      
                      <h6 class="card-title mb-1 small <%= 'text-decoration-line-through text-muted' if todo_item.completed? %>">
                        <%= todo_item.description %>
                      </h6>
                      

                      
                      <% if todo_item.source_type == 'RecurringMeeting' %>
                        <small class="text-muted">
                          <i class="bi bi-clock me-1"></i><%= todo_item.source.frequency_display %>
                        </small>
                      <% elsif todo_item.source_type == 'Goal' %>
                        <% 
                          goal = todo_item.source
                          completion = goal.completion_for_week(@current_week_start)
                          completed_count = current_user.todo_items.where(source: goal, week_start_date: @current_week_start, completed: true).count
                          progress_percentage = goal.target_count > 0 ? (completed_count.to_f / goal.target_count * 100).round(0) : 0
                        %>
                        <div class="d-flex align-items-center mb-1">
                          <small class="text-muted me-2">
                            <i class="bi bi-target me-1"></i>Weekly goal
                          </small>
                          <div class="progress me-2" style="width: 50px; height: 6px;">
                            <div class="progress-bar <%= progress_percentage >= 100 ? 'bg-success' : progress_percentage >= 80 ? 'bg-warning' : 'bg-secondary' %>" 
                                 role="progressbar" 
                                 style="width: <%= [progress_percentage, 100].min %>%"
                                 aria-valuenow="<%= progress_percentage %>" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                          </div>
                          <small class="text-muted me-2">
                            <%= completed_count %>/<%= goal.target_count %>
                          </small>
                          <%= link_to goal_path(goal), class: "btn btn-sm btn-outline-primary p-1", title: "View goal details", style: "font-size: 0.8rem; line-height: 1;" do %>
                            <i class="bi bi-graph-up"></i>
                          <% end %>
                        </div>
                      <% elsif todo_item.source_type == 'AdHocTodo' %>
                        <div class="d-flex align-items-center">
                          <small class="text-muted">
                            <i class="bi bi-list-task me-1"></i>Quick add
                          </small>
                        </div>
                      <% end %>
                    </div>
                  </div>
                  
                  <!-- Notes icon in bottom right -->
                  <div style="position: absolute; bottom: 8px; right: 8px;">
                    <% if todo_item.notes.any? %>
                      <button class="btn btn-sm btn-link text-secondary p-0 view-notes-btn" 
                              data-todo-id="<%= todo_item.id %>"
                              data-notes="<%= todo_item.notes.map(&:content).join(' | ') %>"
                              title="View notes">
                        <i class="bi bi-journal-text"></i>
                      </button>
                    <% else %>
                      <button class="btn btn-sm btn-link text-muted p-0 add-notes-btn" 
                              data-todo-id="<%= todo_item.id %>"
                              title="Add notes">
                        <i class="bi bi-journal-plus"></i>
                      </button>
                    <% end %>
                  </div>
                  
                  <!-- Delete icon in upper right for AdHocTodo items -->
                  <% if todo_item.source_type == 'AdHocTodo' %>
                    <div style="position: absolute; top: 8px; right: 8px;">
                      <%= link_to ad_hoc_todo_path(todo_item.source), 
                          data: { turbo_method: :delete, turbo_confirm: "Remove this to-do item?" },
                          class: "btn btn-sm btn-outline-danger p-1",
                          style: "font-size: 0.7rem; line-height: 1;" do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="bi bi-list-check display-1 text-muted mb-3"></i>
      <h3 class="text-muted">No to-do items for Week <%= @selected_week %></h3>
      <p class="text-muted mb-4">
        <% if @todos_generated %>
          All to-do items have been completed for this week!
        <% else %>
          Click "Generate To-dos" to create items from your meetings and goals.
        <% end %>
      </p>
      <div class="d-flex gap-2 justify-content-center">
        <%= link_to new_recurring_meeting_path, class: "btn btn-primary" do %>
          <i class="bi bi-calendar-event me-1"></i>Add Meeting
        <% end %>
        <%= link_to new_goal_path, class: "btn btn-success" do %>
          <i class="bi bi-target me-1"></i>Add Goal
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">
          <i class="bi bi-journal-text me-2"></i>Add Completion Notes (Optional)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with model: Note.new, local: true, id: "noteForm" do |form| %>
        <div class="modal-body">
          <p class="text-muted mb-3">Add some details about how this task went or what you accomplished (optional):</p>
          
          <%= form.hidden_field :notable_type, id: "note_notable_type" %>
          <%= form.hidden_field :notable_id, id: "note_notable_id" %>
          <%= form.hidden_field :id, id: "note_id" %>
          
          <div class="mb-3">
            <%= form.text_area :content, 
                class: "form-control", 
                rows: 4,
                placeholder: "Describe what you accomplished, any challenges you faced, or notes for next time... (optional)" %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= form.submit "Complete Task", class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
